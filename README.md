# DevCloud 测试方案

## 1. 背景与目标

我们的平台微服务涉及 **认证、产品、渠道、订单、支付、License** 等核心模块，支撑用户购买产品的关键流程。
本次压测的主要目标：

* **稳定性验证**：确认系统在持续高并发下的稳定运行能力
* **容量评估**：找出系统可承载的最大并发量与 TPS
* **性能瓶颈识别**：发现接口或资源的性能瓶颈
* **业务健康验证**：确保关键业务链路（下单、支付、License）在高压下仍能正常完成
* **自动化验证**：逐步建立可持续的自动化测试体系，纳入 CI/CD 流程

---

## 2. 压测范围与模块划分

本次压测覆盖业务链路的主要模块，不包括外部第三方系统（如真实支付平台、外部渠道）。
对于上游或外部依赖，统一通过 **Mock 服务 或 模拟** 替代，保证压测可控。

* **订单系统**

  * 下单：高并发写入数据库，检验下单逻辑
  * 关单：模拟超时订单批量关闭
  * 退款：并发触发退款，验证事务与资金逻辑

* **支付系统**

  * 不调用真实第三方支付
  * 模拟**支付回调通知**，测试高并发回调处理能力

* **License 系统**

  * 接收订单事件，生成并分发 License
  * 验证高并发下的吞吐量与数据一致性

* **认证系统**

  * 所有接口需经过权限验证
  * 压测不同用户并发登录及缓存命中场景

---

## 3. 压测环境

### 环境说明

* **环境配置**：与生产环境保持至少 70% 以上资源规格（CPU/内存/数据库实例数）。
* **隔离措施**：使用独立测试账号与支付模拟，避免污染线上测试环境数据。

---

## 4. 压测思路与流程

### 阶段一：模块压测

* 独立测试各模块接口，发现局部性能瓶颈
* 示例：订单系统单独压测 2k QPS → 验证数据库写入能力

### 阶段二：全链路压测

* 模拟真实用户购买流程：
  下单 → 支付回调 → License 生成
* 使用 JMeter 实现端到端调用链路

### 阶段三：异常与故障场景压测

* **支付回调异常**：乱序、延迟、重复通知
* **缓存异常**：Redis 瞬时清空，观察击穿/雪崩情况
* **依赖故障**：模拟部分服务不可用，验证重试、死信机制
* **突发流量**：短时间内并发从 0 → 5000 QPS

### 阶段四：持续稳定性压测

* 长时间（24h+）保持高并发，观察内存泄漏、线程池耗尽、连接池异常等问题

---

## 5. 压测指标与量化方法

### 系统层指标

* 吞吐量 (TPS/QPS)：每秒完成请求数
* 响应时间：平均值、最大值、P95、P99
* 错误率：失败请求占比
* 系统资源：CPU、内存、GC、磁盘 IO、数据库连接池

### 业务层指标

* 成功下单率
* 支付回调处理成功率
* License 正确生成率

### 量化方式

* **基线测试**：低并发下采集正常指标
* **递增压测**：逐步增加并发，找到性能拐点
* **长时压测**：持续运行，验证稳定性曲线

---

## 6. 工具与监控集成

* **JMeter**

  * 线程组模拟用户并发请求
  * 定时器模拟支付回调延迟
  * 监听器收集吞吐量、响应时间

* **Prometheus + Grafana**

  * JMeter Backend Listener → PushGateway
  * Prometheus 抓取压测数据
  * Grafana 实时展示：

    * 吞吐量曲线
    * 响应时间分布 (P95/P99)
    * 错误率趋势
    * 系统资源占用

---

## 7. 自动化与持续集成

* **自动化扩展**

  * 功能自动化脚本可复用为压测脚本
  * 典型业务流程配置为 JMeter 测试计划

* **CI/CD 集成**

  * 小规模性能验证可纳入流水线
  * 全量压测放到专用性能环境
  * 测试报告与监控截图归档

* **结果管理**

  * 定期基线对比，追踪性能波动
  * 将性能数据纳入发布门禁

---

## 8. 输出内容

* **压测报告**

  * 并发曲线、响应时间分布、错误率统计
  * 容量拐点与性能瓶颈分析
  * 优化建议与下一步行动
* **Grafana 面板截图**

  * 吞吐量、响应时间、错误率、系统资源趋势

---

## 9. 后续迭代

* **数据规模扩展**：逐步扩大数量量（十万、百万级订单/License）
* **脚本优化**：增加更真实的用户等待/行为路径
* **异常覆盖**：补充更多依赖降级、网络抖动场景
* **持续优化闭环**：压测 → 定位瓶颈 → 优化 → 再压测

---
